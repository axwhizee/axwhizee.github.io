# GitHub Pages博客最新文章自动邮件推送系统说明文档

## 一、系统总体架构与运行流程

本指南所构建的自动化系统，旨在实现对 GitHub Pages 博客项目中 `./_posts` 目录下最新文章的定期监测与邮件推送。整个流程由 **GitHub Actions** 驱动，结合自定义 Python 脚本，形成一个安全、可靠、无需人工干预的 CI/CD 自动化工作流。

### 系统核心组成

该系统主要由以下四个关键组件协同工作：

- **GitHub 仓库**：存放博客源码，其中 `./_posts` 目录存储所有 Markdown 格式的文章。
- **Python 处理脚本** (`fetch_latest_posts.py`)：负责调用 GitHub API 获取最新文章信息，提取标题与摘要，并通过 SMTP 协议发送邮件。
- **GitHub Actions 工作流** (`weekly_email_workflow.yml`)：定义自动化任务的触发条件、执行环境和操作步骤。
- **加密 Secrets 存储**：在仓库设置中安全地保存邮箱账号、密码等敏感凭证，供工作流运行时动态注入。

### 运行流程详解

1. **定时触发**：工作流根据预设的 cron 表达式，在每周一 00:00 (UTC) 自动启动。
2. **代码检出**：Actions Runner 拉取仓库的最新代码，确保脚本能访问到最新的 `_posts` 文件。
3. **环境准备**：在 Ubuntu 虚拟机上安装指定版本的 Python，并加载项目依赖（如 `requests`, `python-dotenv`）。
4. **脚本执行**：
    - 脚本从环境变量中读取由 Secrets 注入的 SMTP 配置。
    - 通过 GitHub REST API 查询 `_posts` 目录相关的最近一次提交记录，以确定最新发布的文章。
    - 获取该文章的原始内容，解析并提取其标题和前几段文字作为摘要。
    - 构建邮件正文，并连接至指定的 SMTP 服务器。
5. **邮件发送**：使用发件人账户将包含最新文章摘要的邮件发送至预设的收件人邮箱。

> **重要提示**：GitHub Actions 使用 UTC 时间。若需在北京时间每周一 0 点执行，应将 cron 表达式调整为 `0 16 * * 0`（即上周日 16:00 UTC）<sup>[1],[2]</sup>。

### 定时机制可视化说明

以下图表清晰地展示了 cron 表达式的五个字段及其对应的时间单位：

### Cron 表达式字段说明

| 字段位置 | 含义       | 取值范围           |
|----------|------------|--------------------|
| 第一位   | 分钟       | 0–59               |
| 第二位   | 小时       | 0–23               |
| 第三位   | 日期       | 1–31               |
| 第四位   | 月份       | 1–12               |
| 第五位   | 星期       | 0–6 (0 表示周日)    |

**数据说明:**  
- Cron 表达式共包含五个时间字段，按顺序分别表示分钟、小时、日期、月份和星期。  
- 每个字段有固定的取值范围，用于定义定时任务的执行时间。  
- 星期字段中，0 和 7 都代表周日，但推荐使用 0 提高可读性。

## 二、密钥与环境变量配置指南

为确保系统的安全性与可维护性，所有敏感信息（如邮箱账号、密码等）均不得硬编码于脚本或配置文件中。本指南提供两种环境下的密钥管理方案：在 **GitHub Actions 生产环境** 中使用仓库 Secrets，在 **本地开发测试环境** 中使用 `.env` 文件加载。

### 1. GitHub Actions 环境：配置仓库 Secrets

在 GitHub 仓库的设置中，需预先定义以下五个 Secrets，供工作流运行时动态注入为环境变量：

| Secret名称 | 用途说明 | 示例值 |
| --- | --- | --- |
| `EMAIL_USER` | 发件人邮箱地址，用于登录SMTP服务器并显示在“发件人”字段 | `sender@gmail.com` <sup>[3],[4]</sup> |
| `EMAIL_PASSWORD` | 邮箱账户的**应用专用密码**或**授权码**，非登录密码 | `xxxx xxxx xxxx xxxx` <sup>[3],[4]</sup> |
| `RECIPIENT_EMAIL` | 目标收件人邮箱地址，即接收最新文章摘要的邮箱 | `reader@example.com` <sup>[3]</sup> |
| `SMTP_SERVER` | 邮件服务商提供的SMTP服务器地址 | `smtp.gmail.com` 或 `smtp.qq.com` <sup>[3]</sup> |
| `SMTP_PORT` | SMTP服务端口号，根据加密方式选择SSL或TLS对应端口 | `587`（推荐）或 `465` <sup>[3]</sup> |

> **配置路径**：进入您的 GitHub 仓库 → **Settings** → **Secrets and variables** → **Actions** → **New repository secret**

### 2. 本地开发环境：使用 `.env` 文件

在本地调试 Python 脚本时，建议使用 `python-dotenv` 库从 `.env` 文件中加载配置，避免将凭证提交至版本控制系统。

首先，安装依赖：
```bash
pip install python-dotenv
```

然后，在项目根目录创建 `.env` 文件，内容如下：
```env
# 邮件发送配置
SMTP_SERVER=smtp.qq.com
SMTP_PORT=587
EMAIL_USER=your_email@qq.com
EMAIL_PASSWORD=your_auth_code_here
RECIPIENT_EMAIL=test@example.com
```

同时，请确保在 `.gitignore` 文件中添加 `.env`，防止意外泄露：
```
.env
email_sender.log
```

脚本会自动通过 `os.getenv()` 读取这些变量，实现与生产环境一致的行为逻辑 <sup>[5],[6],[7]</sup>。

### 3. 授权码获取说明

部分主流邮箱服务禁止使用登录密码直接通过第三方应用发送邮件，必须启用“应用专用密码”或“授权码”：

- **QQ邮箱**：前往「设置 → 账户」，开启IMAP/SMTP服务，按短信验证流程生成16位授权码 <sup>[8],[9],[10]</sup>
- **Gmail**：需先开启两步验证，再于「安全 → 应用专用密码」中生成16位密码 <sup>[11],[12]</sup>
- **163邮箱**：在「设置 → POP3/SMTP/IMAP」中开启服务并设置客户端授权密码 <sup>[10],[13]</sup>

请务必使用上述生成的授权码作为 `EMAIL_PASSWORD` 的值，以保障账户安全。

## 三、部署实施步骤详解

为确保本指南所述自动化系统能够顺利部署并稳定运行，请严格按照以下五个步骤进行操作。每一步均经过验证，适用于标准的 GitHub Pages + Jekyll 博客项目结构。

### 1. 准备 Python 处理脚本

将名为 `fetch_latest_posts.py` 的 Python 脚本放置于仓库根目录下。该脚本负责调用 GitHub API 获取 `_posts` 目录中最新发布的文章，并通过 SMTP 发送邮件通知。

> **注意**：请勿修改脚本中的逻辑结构，其已内置异常处理与日志记录功能 <sup>[5],[6],[14]</sup>。

```python
# 示例：脚本文件应以如下方式存在于项目中
your-repo/
├── _posts/
│   └── 2023-01-01-sample-post.md
├── fetch_latest_posts.py     # ← 放置于此
├── .github/
│   └── workflows/
└── ...
```

### 2. 创建依赖管理文件

在项目根目录创建 `requirements.txt` 文件，明确列出脚本所需依赖库及其版本，以保证运行环境一致性：

```txt
requests>=2.28.0
python-dotenv>=1.0.0
```

此文件将在 GitHub Actions 运行时被自动读取并安装，确保脚本具备调用 API 和加载环境变量的能力 <sup>[1],[15]</sup>。

### 3. 配置 GitHub Actions 工作流

创建工作流配置文件 `.github/workflows/weekly_email_workflow.yml`，内容如下：

```yaml
name: Weekly Blog Post Notification
on:
  schedule:
    - cron: '0 0 * * 1'  # 每周一 00:00 UTC
  workflow_dispatch:
    inputs: {}
jobs:
  send-latest-post:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Dependencies
        run: |
          pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      - name: Run Fetch Script
        env:
          EMAIL_USER: ${{ secrets.EMAIL_USER }}
          EMAIL_PASSWORD: ${{ secrets.EMAIL_PASSWORD }}
          RECIPIENT_EMAIL: ${{ secrets.RECIPIENT_EMAIL }}
          SMTP_SERVER: ${{ secrets.SMTP_SERVER }}
          SMTP_PORT: ${{ secrets.SMTP_PORT }}
        run: python fetch_latest_posts.py
```

> **关键路径**：该文件必须位于 `.github/workflows/` 目录下，GitHub 才能识别并启用此自动化任务 <sup>[16],[17]</sup>。

### 4. 提交并推送至远程仓库

完成上述文件创建后，执行 Git 提交操作，并将更改推送到主分支（通常是 `main` 或 `master`）：

```bash
git add fetch_latest_posts.py requirements.txt .github/workflows/weekly_email_workflow.yml
git commit -m "feat: add weekly email notification workflow"
git push origin main
```

一旦提交成功，GitHub 将自动扫描 `.github/workflows/` 目录下的 YAML 文件，并注册新的定时任务。

### 5. 验证与首次运行

建议通过手动触发方式验证流程是否正常：

1. 进入仓库的 **Actions** 标签页；
2. 在左侧选择 “Weekly Blog Post Notification” 工作流；
3. 点击 “Run workflow” 下拉按钮，选择 “Run now”。

观察执行日志，确认各步骤状态均为绿色对勾 ✅，且收件人邮箱成功收到包含最新文章摘要的邮件。若失败，请参考第四章进行排查。

## 四、常见问题与故障排查方法

在部署和运行本自动化系统过程中，可能会遇到各类技术问题。本章汇总了最常见故障场景，并提供系统性的诊断思路与解决方案，帮助您快速定位并修复问题。

### 1. 邮件发送失败

邮件无法送达是最常见的运行异常，通常由SMTP配置或账户权限问题引起。

**可能原因与应对策略：**

- **SMTP连接超时或拒绝**
    - 检查 `SMTP_SERVER` 和 `SMTP_PORT` 是否正确匹配邮箱服务商要求 <sup>[8],[11]</sup>。
    - 确认使用的是**应用专用密码**而非登录密码，特别是对于 Gmail、QQ 邮箱等服务 <sup>[9],[12]</sup>。

- **认证失败（401 Unauthorized）**
    - 验证 `EMAIL_USER` 与 `EMAIL_PASSWORD` 在 GitHub Secrets 中拼写无误。
    - 重新生成授权码并更新 Secrets，旧码可能已失效。

- **收件人未收到邮件**
    - 检查垃圾邮件文件夹，部分自动邮件会被过滤。
    - 确保 `RECIPIENT_EMAIL` 地址有效且可接收外部邮件。

### 2. Python脚本执行报错

脚本在 Actions 运行时可能出现异常，需结合日志进行分析。

**典型错误及处理方式：**

- **GitHub API 返回 403 Forbidden**
    - 若访问私有仓库，必须在请求头中提供有效的 Personal Access Token (PAT)。
    - 确保 PAT 具备 `repo` 权限，并通过环境变量注入脚本 <sup>[18],[19]</sup>。

- **“未找到最新文章”或空响应**
    - 确认 `_posts` 目录中存在 `.md` 文件，且至少有一次提交涉及该路径。
    - 脚本依赖提交历史判断“最新”，若仅添加文件但未推送，将无法识别。

- **环境变量读取为空**
    - 检查工作流 YAML 中 `env:` 字段是否正确映射 Secrets。
    - 确保 Secrets 名称大小写完全一致（如 `EMAIL_USER` ≠ `email_user`）<sup>[20],[21]</sup>。

### 3. 工作流未按预期触发

定时任务未能启动，可能是调度配置或仓库设置问题。

| 问题现象 | 可能原因 | 排查方法 | 解决方案 |
| --- | --- | --- | --- |
| 每周一未自动运行 | cron 表达式时间误解 | 确认 GitHub 使用 UTC 时间 | 如需北京时间0点执行，应设为 `0 16 * * 0` <sup>[1],[2]</sup> |
| 手动触发也失败 | 仓库 Actions 被禁用 | 进入 Settings → Actions → Permissions | 启用“Allow all actions”或指定允许范围 |
| 持续显示“等待”状态 | 分支保护规则限制 | 检查是否对 `main` 分支设置了强制审查 | 调整策略以允许 Actions 自动运行 |

### 4. 安全与日志建议

为提升系统的可观测性与安全性，建议采取以下措施：

- **启用详细日志记录**
    - 脚本已内置 `logging` 模块，运行日志会输出到控制台及 `email_sender.log` 文件。
    - 在 Actions 日志中搜索关键字如 `Error:` 或 `Failed` 可快速定位问题。

- **定期验证 Secrets 有效性**
    - 邮箱密码或授权码变更后，务必同步更新仓库 Secrets。
    - 避免在代码或提交记录中硬编码任何敏感信息 <sup>[5],[6],[22]</sup>。

- **测试本地环境一致性**
    - 使用 `.env` 文件在本地模拟运行脚本，确保逻辑正确后再部署至生产环境。
    - 安装依赖时使用 `pip install -r requirements.txt` 保证版本一致 <sup>[1],[15]</sup>。

通过以上排查指南，绝大多数运行问题均可被迅速解决。建议首次部署时通过手动触发（`workflow_dispatch`）进行全流程验证，确认无误后再交由定时机制自动执行。

[1]:https://blog.csdn.net/i89211/article/details/144881603 "GitHub Actions 工作流编写指南_github workflow代码教程-CSDN博客"
[2]:https://blog.csdn.net/yyz_1987/article/details/129850406 "白嫖github的Action做定时任务_github定时任务-CSDN博客"
[3]:https://juejin.cn/post/7559644748690047022 "GitHub Actions 自动化：Commit 推送后自动发送邮件通知     GitHub Actions 自动 - 掘金"
[4]:https://www.cnblogs.com/cxfs/p/16991543.html "GitHub Actions 入门教程 - 遗失的美好灬 - 博客园"
[5]:https://www.jb51.net/python/349264mhj.htm "基于Python+smtplib实现邮件自动发送功能_python_脚本之家"
[6]:https://blog.csdn.net/qq_51601665/article/details/151414517 "用Python+smtplib实现邮件自动发送，日常工作效率提升300%_dataframe通过smtplib发送时如何保持格式-CSDN博客"
[7]:http://www.51testing.com/mobile/view.php?itemid=7805158 "Python实战：借助Mailtrap SMTP与电子邮件API实现邮件发送功能 - 51Testing软件测试网-软件测试人的精神家园"
[8]:https://www.jb51.net/python/3550379di.htm "Python实现Excel批量处理+邮件自动发送的全流程_python_脚本之家"
[9]:https://www.jb51.net/python/3517333ia.htm "Python3实现SMTP发送邮件的实战指南_python_脚本之家"
[10]:https://blog.csdn.net/qq_35899016/article/details/149407195 "邮件自动化：Python一键群发邮件，自动收发附件，告别手动操作！你的智能邮件管家！_邮件群发smtp客户端-CSDN博客"
[11]:https://www.php.cn/faq/1707971.html "Python smtplib发送邮件超时问题：Gmail账户配置与解决方案-Python教程-PHP中文网"
[12]:https://www.php.cn/faq/1839246.html "Python邮件发送：动态内容嵌入与F-string实践指南-Python教程-PHP中文网"
[13]:http://www.jb51.net/python/358511o8k.htm "使用Python实现自动发送邮件的实战指南(以QQ/163为例)_python_脚本之家"
[14]:https://blog.csdn.net/vxtkjzxt888/article/details/153271824 "自动化脚本：Python实现邮件自动发送的完整指南_如何通过脚本发送邮件-CSDN博客"
[15]:https://blog.csdn.net/gitblog_00007/article/details/139895593 "使用GitHub Actions设置Python环境教程-CSDN博客"
[16]:https://docs.github.com/zh/actions/writing-workflows/quickstart?ref=ghost... "GitHub Actions 快速入门 - GitHub 文档"
[17]:https://blog.csdn.net/2503_92145588/article/details/150388184 "深入解析 GitHub Actions 工作流文件编写：从入门到实战_github workflow 详解-CSDN博客"
[18]:https://worktile.com/kb/ask/531564.html "如何在github上爬取项目 • Worktile社区"
[19]:https://blog.csdn.net/weixin_40378209/article/details/141940996 "Ubuntu Python与GitHub API 交互，获取仓库更新信息_ubuntu github-CSDN博客"
[20]:https://docs.github.com/zh/enterprise-server@3.17/actions/how-tos/write-workflows/choose-what-workflows-do/use-secrets?tool=webui "在 GitHub Actions 中使用机密 - GitHub Enterprise Server 3.17 Docs"
[21]:https://docs.github.com/zh/enterprise-cloud@latest/actions/how-tos/write-workflows/choose-what-workflows-do/use-secrets "在 GitHub Actions 中使用机密 - GitHub Enterprise Cloud Docs"
[22]:https://developer.aliyun.com/article/1711482 "Python与AWS SES：用Boto库实现邮件自动化发送全攻略-阿里云开发者社区"
